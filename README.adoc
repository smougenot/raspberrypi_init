# Some tooling to automate Rapberry pi installation

Goa of this repo is to easy rapid raspberry pi installation.
Doing this in a repeatable ... and fast way. Yes your pi wil fail eventually and you will have to do a fresh start soon.

My use case samples :
- use pi 4 power to host service based on docker (e.g. influxdb, gitlab, grafana, nodered, ...)
- use pi zero as a web entry port (inside DMZ) for static web hosting, reverse proxy, certificate (SSL) management
- use pi 3 for PiHole (personal data protection, add block, ...).
- use several pi to listen to the music in all the rooms (MPD, snapcast server / client)

## Process overview

1- Get Raspian OS image
2- Prepare storage (one SD is required for pi 4 ... may be fixed in the future by a new firmware)
3- Tune the storage (before it is in the pi) using this repo Ansible tools
4- Tune the pi on first boot (for a minimum safety; e.g. pasword tuning, firewall, ...)
5- Tune the pi OS (thanks to debian tunning role found on Ansible Galaxy)
6- Put this pi at work (e.g. use docker to track weather / home conditions)

## Storage layout ... accomodating pi 4

Today pi 4 can not run on USB only storage.
You can find a lot of tutos to use USB as the main storage for your pi 4.
e.g.
 - https://www.tomshardware.com/news/boot-raspberry-pi-from-usb,39782.html
 - https://gist.github.com/lucabelluccini/9a11c48dcf1d627bbcbd8213f6de3eae

 So we will keep sd card for the little `boot` partition and use USB storage for ... all the rest.

 ## Get Raspian OS

 You can find your way at the [official Raspian download site](https://www.raspberrypi.org/documentation/installation/installing-images/README.md)

## Prepare storage

Goal : have OS ready on the storage devices used for the pi.

### find storage device

We will use 2 storages
   * one SD card for `boot`
   * one USB storage (SSD is better but you can give it a try with a simple flash drive) for `root`

### Burn the image onto the storages

(yes I know I'm old ... enought to have actually burned CD and DVD ... yes a long time ago)

We have to 'burn' the image on each of those storage (yes double work).

My tool of choice is [Etcher](https://etcher.download/)

### Remove unused partitions

As mentionned at the beginning each storage device will be responsible for hosting only one partition.
But we burned the same thing on both of them. It means we have both partitions (`rootfs` and `boot`) on each storage device.

Use your partition tool of choice to remove what we do not need :
* remove `rootfs` partition from the SD card
* remove `boot` partition from the USB storage

Because we used the same image we do not need to bother about `PARTUUID` they are correct.

At this point we can rely on automation provided by this repo

## Tune the OS before first boot

Goal : make sure our pi will boot

### Prepare tools

First we need Ansible to run all this.
You can find what we need at [Ansible installation instruction page](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-with-pip)

### Gather settings informations

1- find where is the boot partition.
Usualy on recent linux partitions are automaically mounted.
So just make sure your SD card is in ... and grab the path associated.
e.g.

    df -h
    /dev/sdb1   253M     53M  200M  21% /run/media/smougenot/boot
So in my case `boot` partition content is in `/run/media/smougenot/boot`

2- Wifi
If you need your pi to use Wifi, we need to add information about it.
* the wifi ssid
* the password

### launch Ansible to tune `boot` partition content

In this very same directory where this documentation is you have a sample shell script `raspian_sd_init.sh.sample`.
* copy it or rename it (to get rid of the `.sample` extension)
* customise it with the information gather earlier
* execute the customised script

