---

- name: update pi user to add ssh authorisez keys
  authorized_key:
    user: 'pi'
    state: present
    key: "{{ lookup('file', raspian_first_boot_pi_pub_key) }}"

- name: update pi user password
  user:
    name: 'pi'
    password: '{{ raspian_first_boot_pi_password }}'
    update_password: 'always'
  when: raspian_first_boot_pi_password is defined and raspian_first_boot_pi_password | trim | length > 0

# change sshd
- name: ssh strenghtening (e.g. no more password login)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  with_items:
    - regexp: '^PermitRootLogin\s+(yes|no)$'
      line:    'PermitRootLogin no'
    - regexp: '^PasswordAuthentication\s+(yes|no)$'
      line:    'PasswordAuthentication no'
    - regexp: '^UsePAM\s+(yes|no)$'
      line:    'UsePAM no'
    - regexp: '^ClientAliveInterval\s+\d+$'
      line:    'ClientAliveInterval 360'
    - regexp: '^ClientAliveCountMax\s+\d+$'
      line:    'ClientAliveCountMax 0'
  notify: 'sshd restart'
- name: ssh change port
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port\s+\d+$'
    line:   'Port {{ raspian_first_boot_ssh_port }}'
    state: present
  notify: 'sshd restart'
  when: raspian_first_boot_ssh_port is defined and raspian_first_boot_ssh_port | trim | length > 0

# change host name .... will require reboot
- block:
  - name: change host name
    hostname:
      name: "{{ raspian_first_boot_hostname }}"
    register: change_hostname

  - name: adjust /etc/hosts
    replace:
      path: '/etc/hosts'
      regexp: '{{ inventory_hostname | regex_replace('\.local$','')}}'
      replace: '{{ raspian_first_boot_hostname }}'
    when: change_hostname.changed

  when: raspian_first_boot_hostname is defined

# reboot
- name: Reboot machine
  shell: sleep 2 && shutdown -r +1 "Ansible updates triggered"
  async: 1
  poll: 0
  ignore_errors: true
  when: change_hostname is defined and change_hostname.changed
